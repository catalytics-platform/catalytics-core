-- Add migration script here
CREATE TABLE IF NOT EXISTS badges (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    score INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_badges_created_at
    ON badges (created_at);

INSERT INTO badges (id, title, description, score) VALUES
    (1, 'First Cube Cat', 'Register for our private beta', 1),
    (2, 'Silver Early Supporter', 'Hold 10.000 $CATICS or more', 1),
    (3, 'Golden Early Supporter', 'Hold 100.000 $CATICS or more', 1),
    (4, 'Distinguished Early Supporter', 'Hold 1.000.000 $CATICS or more', 1),
    (5, 'Early Miner', 'Mine with your cat in season 0', 1),
    (6, 'Stronger Cat', 'Upgrade a cat to level 2', 1),
    (7, 'Planetary Feline', 'Stake at least 100 $JUP', 1);

CREATE TABLE IF NOT EXISTS badge_groups (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_badge_groups_created_at
    ON badge_groups (created_at);

INSERT INTO badge_groups (id, title, description) VALUES
    (1, 'Private Beta Badges', 'Start earning your badges before the game launches');

CREATE TABLE IF NOT EXISTS badge_group_conjunctions (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    badge_id INTEGER NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
    badge_group_id INTEGER NOT NULL REFERENCES badge_groups(id) ON DELETE CASCADE,
    sort_order INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_badge_group_conjunctions_badge_group_id
    ON badge_group_conjunctions (badge_group_id);

CREATE INDEX IF NOT EXISTS idx_badge_group_conjunctions_sort_order
    ON badge_group_conjunctions (sort_order);

CREATE INDEX IF NOT EXISTS idx_badge_group_conjunctions_created_at
    ON badge_group_conjunctions (created_at);

INSERT INTO badge_group_conjunctions (badge_id, badge_group_id, sort_order) VALUES
    (1, 1, 10),
    (2, 1, 20),
    (3, 1, 30),
    (4, 1, 40),
    (5, 1, 50),
    (6, 1, 60),
    (7, 1, 70);

CREATE TABLE IF NOT EXISTS progression_event_types (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    event_type TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

INSERT INTO progression_event_types (id, event_type) VALUES
    (1, 'beta_applicant_created'),
    (2, 'catics_balance_check'),
    (3, 'mine_season_0'),
    (4, 'cat_level_up'),
    (5, 'jup_staked');

CREATE TABLE IF NOT EXISTS badge_conditions (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    badge_id INTEGER NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
    progression_event_type_id INTEGER NOT NULL REFERENCES progression_event_types(id) ON DELETE CASCADE,
    operation TEXT NOT NULL,
    required_count INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    UNIQUE (badge_id, progression_event_type_id)
);

CREATE INDEX IF NOT EXISTS idx_badge_conditions_badge_id
    ON badge_conditions (badge_id);

CREATE INDEX IF NOT EXISTS idx_badge_conditions_progression_event_type_id
    ON badge_conditions (progression_event_type_id);

CREATE INDEX IF NOT EXISTS idx_badge_conditions_created_at
    ON badge_conditions (created_at);

INSERT INTO badge_conditions (id, badge_id, progression_event_type_id, operation, required_count) VALUES
    (1, 1, 1, 'eq', 1),
    (2, 2, 2, 'gte', 10_000),
    (3, 3, 2, 'gte', 100_000),
    (4, 4, 2, 'gte', 1_000_000),
    (5, 5, 3, 'gte', 1),
    (6, 6, 4, 'gte', 2),
    (7, 7, 5, 'gte', 100);

CREATE TABLE IF NOT EXISTS beta_applicant_progressions (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    beta_applicant_id INTEGER NOT NULL REFERENCES beta_applicants(id) ON DELETE CASCADE,
    progression_event_type_id INTEGER NOT NULL REFERENCES progression_event_types(id) ON DELETE CASCADE,
    progress_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    UNIQUE (beta_applicant_id, progression_event_type_id)
);

CREATE INDEX IF NOT EXISTS idx_beta_applicant_progressions_beta_applicant_id
    ON beta_applicant_progressions (beta_applicant_id);

CREATE INDEX IF NOT EXISTS idx_beta_applicant_progressions_progression_event_type_id
    ON beta_applicant_progressions (progression_event_type_id);

CREATE INDEX IF NOT EXISTS idx_beta_applicant_progressions_beta_applicant_progression_id
    ON beta_applicant_progressions (beta_applicant_id, progression_event_type_id);

INSERT INTO beta_applicant_progressions (beta_applicant_id, progression_event_type_id, progress_count, created_at)
SELECT id, 1, 1, created_at
FROM beta_applicants;

CREATE TABLE IF NOT EXISTS beta_applicant_badges (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    beta_applicant_id INTEGER NOT NULL REFERENCES beta_applicants(id) ON DELETE CASCADE,
    badge_id INTEGER NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    UNIQUE (beta_applicant_id, badge_id)
);

CREATE INDEX IF NOT EXISTS idx_beta_applicant_badges_beta_applicant_id
    ON beta_applicant_badges (beta_applicant_id);

CREATE INDEX IF NOT EXISTS idx_beta_applicant_badges_badge_id
    ON beta_applicant_badges (badge_id);

INSERT INTO beta_applicant_badges (beta_applicant_id, badge_id, created_at)
SELECT id, 1, created_at
FROM beta_applicants;